#!/usr/bin/env fish

# åˆ¤æ–­å‚æ•°
if test (count $argv) -lt 1
    echo "ç”¨æ³•: sort_picture.fish [-c] <ç›®å½•è·¯å¾„> [å‰ç¼€å­—ç¬¦ä¸²]"
    exit 1
end

set convert_mode 0
set folder ""
set prefix ""


if test "$argv[1]" = "-c"
    set convert_mode 1
    set folder $argv[2]
	set prefix (basename (echo $folder |  tr -d '/'))
    if test (count $argv) -ge 3
        set prefix $argv[3]
    end
else
    set folder $argv[1]
	set prefix (basename (echo $folder |  tr -d '/'))
    if test (count $argv) -ge 2
        set prefix $argv[2]
    end
end

if test (count $argv) -eq 3
    set prefix $argv[3]
end

# æ ¡éªŒç›®å½•
if not test -d $folder
    echo "âŒ ç›®å½•ä¸å­˜åœ¨: $folder"
    exit 1
end

set folder (string trim -- $folder)

# ===== -c æ¨¡å¼ï¼šå…ˆè½¬æ¢ä¸º pngï¼Œå†é«˜æ¸…åŒ– =====
if test $convert_mode -eq 1
    echo "ğŸ” è¿›å…¥ waifu2x è½¬æ¢æ¨¡å¼"
    # è½¬æ¢ jpg/jpeg ä¸º png
    for img in $folder/*.jpg $folder/*.jpeg
        if test -e $img
            set output (string replace -r '\.(jpg|jpeg)$' '.png' -- $img)
            ffmpeg -y -i $img $output >/dev/null 2>&1
            if test $status -eq 0
                rm $img
                echo "ğŸ“¸ å·²è½¬ä¸º PNG: $output"
            else
                echo "âš ï¸ è½¬æ¢å¤±è´¥: $img"
            end
        end
    end

    # é«˜æ¸…åŒ–æ‰€æœ‰ PNGï¼Œè¾“å‡ºä¸º *_convert.png
    for img in $folder/*.png
		if test (stat -c%s $img) -gt 2097152
			echo "â­ï¸ æ–‡ä»¶è¿‡å¤§è·³è¿‡: $img"
			continue
		end
        if test -e $img
            set output (string replace -r '\.png$' '_convert.png' -- $img)
            if test "$img" = "$output"
                continue
            end
            waifu2x-ncnn-vulkan -i $img -o $output -n 1 -s 2 >/dev/null 2>&1
            if test $status -eq 0
                echo "âœ¨ é«˜æ¸…å®Œæˆ: $output"
            else
                echo "âš ï¸ é«˜æ¸…å¤±è´¥: $img"
            end
        end
    end

    # æ¸…é™¤åŸå§‹ pngï¼Œåªä¿ç•™ *_convert.pngï¼Œå¹¶å»æ‰ _convert åç¼€
    for img in $folder/*_convert.png
        set original (string replace '_convert.png' '.png' -- $img)
        mv $img $original
    end

    echo "âœ… è½¬æ¢å®Œæˆ"
end

# ===== æ‰§è¡Œç»Ÿä¸€é‡å‘½åæµç¨‹ =====

# æŸ¥æ‰¾æœ€å¤§ç¼–å·
set max_index 0
for file in (ls -1 $folder)
    set base "$prefix"_
    set pattern "^"$base"[0-9]+\\.[^./]+"
    if string match -rq $pattern $file
        set num (string replace -r "^$base" "" -- $file | string replace -r '\\..*' '')
        if test "$num" -gt "$max_index"
            set max_index $num
        end
    end
end

set i (math $max_index + 1)

# éå†æœªå‘½åæ–‡ä»¶
for file in (ls -1 $folder | sort)
    set full_path "$folder/$file"
    if not test -f $full_path
        continue
    end

    set base "$prefix"_
    set pattern "^"$base"[0-9]+\\.[^./]+"
    if string match -rq $pattern $file
        echo "â­ï¸ å·²å‘½åè·³è¿‡: $file"
        continue
    end

    set ext (string match -r '\.[^./]*$' $file)
    set new_name "$prefix"_"$i""$ext"
	set new_path (string trim -- "$folder")"/"(string trim -- "$new_name")


    mv $full_path $new_path
    echo "âœ… $file â†’ $new_name"

    set i (math $i + 1)
end

